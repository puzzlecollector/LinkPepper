<!doctype html>
{% load static %}
<html lang="{{ meta.lang|default:'en' }}">
    <head>
        {% include "partials/gtm_head.html" %}
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>{{ meta.title|default:"LinkHash | Leaderboard" }}</title>
        <link rel="canonical" href="{{ meta.canonical|default:meta.url }}">
        <meta name="robots" content="index,follow">
        <meta name="author" content="LinkHash">
        <meta name="description" content="{{ meta.description|default:'Top contributors ranked by campaign participation.' }}">
        <!-- OG/Twitter -->
        <meta property="og:type" content="website">
        <meta property="og:site_name" content="LinkHash">
        <meta property="og:title" content="{{ meta.og_title|default:meta.title }}">
        <meta property="og:description" content="{{ meta.og_description|default:meta.description }}">
        <meta property="og:url" content="{{ meta.url }}">
        <meta property="og:image" content="{% static 'img/og-cover.png' %}">
        <meta name="twitter:card" content="summary_large_image">
        <meta name="twitter:title" content="{{ meta.og_title|default:meta.title }}">
        <meta name="twitter:description" content="{{ meta.og_description|default:meta.description }}">
        <meta name="twitter:image" content="{% static 'img/twitter-card.png' %}">
        <!-- Favicons -->
        <link rel="icon" href="{% static 'img/favicon.ico' %}">
        <style>
      :root{
        --bg:#0a0b0d; --bg-elev:#0f1115; --panel:#11141a; --panel-2:#0e1318; --grid:#0b0f13;
        --line:#1a212d; --text:#e6f1ee; --muted:#9fb0aa; --green:#16a34a; --green-2:#23d16a;
        --glow:0 0 22px rgba(22,163,74,.35), 0 0 48px rgba(22,163,74,.15);
        --radius:16px; --shadow-lg:0 40px 80px rgba(0,0,0,.55), inset 0 -1px 0 rgba(255,255,255,.03);
        --shadow-md:0 16px 40px rgba(0,0,0,.45);
        --noise:transparent url('data:image/svg+xml;utf8,\
          <svg xmlns="http://www.w3.org/2000/svg" width="120" height="120" viewBox="0 0 120 120">\
            <filter id="n"><feTurbulence type="fractalNoise" baseFrequency="0.9" numOctaves="2" stitchTiles="stitch"/></filter>\
            <rect width="120" height="120" filter="url(%23n)" opacity=".04"/></svg>') repeat;
        --container:clamp(960px, 80vw, 1200px);
      }
      *{box-sizing:border-box}
      html,body{height:100%}
      body{
        margin:0; color:var(--text);
        background:
          radial-gradient(80rem 60rem at 90% -10%, rgba(22,163,74,.12), transparent 60%),
          radial-gradient(60rem 40rem at -20% 20%, rgba(35,209,106,.08), transparent 60%),
          linear-gradient(180deg, #08090b, #0a0b0d 20%, #090c10),
          var(--noise);
        font-family: ui-sans-serif, "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
                     "Apple SD Gothic Neo", "Noto Sans KR", "Noto Sans JP", "Noto Sans SC", Arial, sans-serif;
        letter-spacing:.2px; background-attachment: fixed;
      }
      a{color:inherit;text-decoration:none}
      .container{width:var(--container); margin:0 auto; padding:0 20px;}

      /* NAV */
      .nav{position:sticky; top:0; z-index:60; backdrop-filter: blur(12px);
        background:linear-gradient(180deg, rgba(15,17,21,.75), rgba(15,17,21,.45));
        border-bottom:1px solid rgba(255,255,255,.06);}
      .nav .row{display:flex; align-items:center; justify-content:space-between; height:72px;}
      .brand{display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.4px; color:#d8ffe7; text-shadow:0 0 18px rgba(35,209,106,.24);}
      .brand .dot{width:10px;height:10px;border-radius:999px;background:var(--green);box-shadow:var(--glow)}
      .links{display:flex; gap:24px; align-items:center;}
      .links a{color:#cfe7dd; opacity:.9}
      .links a:hover{color:#fff; text-shadow:0 0 12px rgba(35,209,106,.25)}
      .btn{display:inline-flex; align-items:center; gap:10px; padding:12px 16px; font-weight:800; border-radius:12px; background:linear-gradient(180deg,#19b357,#119e49); color:#05160c; box-shadow:var(--glow); border:1px solid #2fe07a}
      .btn-outline{padding:10px 14px; border-radius:12px; border:1px solid #2a333f; background: rgba(14,18,25,.6); color:#d9f6e6; font-weight:800}

      /* HEADER */
      .page-head{
        padding:48px 0 14px;
        background:linear-gradient(180deg, rgba(12,16,20,.65), rgba(10,12,16,.35)), var(--noise);
        border-bottom:1px solid rgba(255,255,255,.06);
      }
      .page-head h1{margin:0 0 8px; font-size:36px;}
      .page-head .sub{color:var(--muted); margin:0}
      .range{display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:12px;}
      .chip{padding:8px 12px; border-radius:999px; border:1px solid #2a333f; background:#0b1117; color:#cfe7dd; font-weight:800; font-size:13px;}
      .chip.active{border-color:#2fe07a; background:linear-gradient(180deg,#19b357,#119e49); color:#05160c; box-shadow:var(--glow)}

      /* TABLE */
      .board{padding:22px 0 40px;}
      .card{
        background:linear-gradient(180deg, #0f1419, #0c1116);
        border:1px solid rgba(255,255,255,.06); border-radius:18px; box-shadow:var(--shadow-md);
        overflow:hidden;
      }
      table{width:100%; border-collapse:separate; border-spacing:0;}
      thead th{
        text-align:left; font-size:12px; color:#8fb0a5; font-weight:800; letter-spacing:.3px;
        padding:10px 14px; border-bottom:1px solid rgba(255,255,255,.06);
        background:var(--panel);
      }
      tbody td{padding:14px; border-bottom:1px solid rgba(255,255,255,.06); font-size:14px; color:#dbe9e2;}
      tbody tr{transition:background .15s ease}
      tbody tr:hover{background:rgba(22,163,74,.06)}
      .rank{width:70px; font-weight:900; color:#e6f1ee;}
      .user{display:flex; align-items:center; gap:12px; min-width:360px;}
      .avatar{width:36px; height:36px; border-radius:999px; overflow:hidden; border:1px solid #1d2836; background:#0b1117; flex:0 0 36px;}
      .handle{display:flex; flex-direction:column; gap:4px; min-width:0;}
      .addr{font-weight:900; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
      .muted{color:#9fb0aa; font-size:12px;}
      .mind{white-space:nowrap;}
      .stat{white-space:nowrap; text-align:right;}

      /* Network cell */
      .net-cell{min-width:160px;}
      .net{display:flex; align-items:center; gap:10px;}
      .net img{width:24px; height:24px; display:block; filter:drop-shadow(0 2px 6px rgba(0,0,0,.35));}
      .net-name{font-size:13px; color:#cfe7dd; font-weight:800; white-space:nowrap;}

      /* Split bar */
      .bar-split{
        height:10px;
        border:1px solid #1d2836;
        background:
          linear-gradient(
            90deg,
            #19b357 0,
            #23d16a var(--links, 50%),
            #1d6dd3 var(--links, 50%),
            #5aa9ff 100%
          );
        border-radius:999px;
        overflow:hidden;
      }
      .split-meta{display:flex; justify-content:space-between; margin-top:6px; font-size:12px; color:#9fb0aa}
      .empty{padding:30px; text-align:center; color:#a8bab2;}

      /* Language dropdown (nav) */
      .lang{ position:relative; margin-left:8px; }
      .lang-btn{
        display:inline-flex; align-items:center; gap:10px;
        padding:10px 12px; font-weight:800; border-radius:12px;
        border:1px solid #2a333f; background: rgba(14,18,25,.6); color:#d9f6e6;
        cursor:pointer;
      }
      .lang-btn:hover{ border-color:rgba(35,209,106,.35); box-shadow:0 0 16px rgba(35,209,106,.18) }
      .lang .chev{ opacity:.8 }
      .lang-menu{
        position:absolute; top:110%; right:0; width:210px;
        background:linear-gradient(180deg, #0f1419, #0c1116);
        border:1px solid rgba(255,255,255,.08);
        border-radius:12px; box-shadow:0 20px 40px rgba(0,0,0,.45);
        padding:6px; display:none; z-index:70;
      }
      .lang.open .lang-menu{ display:block; animation:menuIn .14s ease-out }
      @keyframes menuIn{ from{ transform:translateY(-6px); opacity:0 } to{ transform:translateY(0); opacity:1 } }
      .lang-item{
        display:flex; align-items:center; gap:10px; padding:10px 10px; border-radius:10px;
        cursor:pointer; color:#cfe7dd; font-weight:800;
      }
      .lang-item:hover{ background:#0b1218; border:1px solid #1d2836 }
      .flag-emoji{
        display:inline-flex; align-items:center; justify-content:center;
        width:18px; height:18px; line-height:18px;
        font-size:14px; border-radius:3px;
        background:rgba(255,255,255,.06);
        box-shadow:inset 0 0 0 1px rgba(255,255,255,.08);
      }

      @media (max-width:1200px){
        .rank{width:60px}
        .addr{max-width:520px}
      }
      @media (max-width:1000px){
        .container{width:min(920px, 100%)}
        .rank{width:54px}
        .addr{max-width:420px}
      }
      @media (max-width:860px){
        .addr{max-width:300px}
      }
        </style>
    </head>
    <body>
        {% include "partials/gtm_body.html" %}
        <!-- NAV -->
        <header class="nav">
            <div class="container row">
                <div class="brand">
                    <span class="dot"></span>
                    <span>LinkHash</span>
                </div>
                <nav class="links">
                    <a href="{% if meta.lang == 'ko' %}/ko/{% elif meta.lang == 'ja' %}/ja/{% elif meta.lang == 'zh' %}/zh/{% else %}/{% endif %}">
                        {% if meta.lang == 'ko' %}홈{% elif meta.lang == 'ja' %}ホーム{% elif meta.lang == 'zh' %}主页{% else %}Home{% endif %}
                    </a>
                    <a href="{% if meta.lang == 'ko' %}/ko/rewards/{% elif meta.lang == 'ja' %}/ja/rewards/{% elif meta.lang == 'zh' %}/zh/rewards/{% else %}/rewards/{% endif %}">
                        {% if meta.lang == 'ko' %}리워드{% elif meta.lang == 'ja' %}リワード{% elif meta.lang == 'zh' %}奖励{% else %}Rewards{% endif %}
                    </a>
                    <a href="{% if meta.lang == 'ko' %}/ko/events/{% elif meta.lang == 'ja' %}/ja/events/{% elif meta.lang == 'zh' %}/zh/events/{% else %}/events/{% endif %}">
                        {% if meta.lang == 'ko' %}이벤트{% elif meta.lang == 'ja' %}イベント{% elif meta.lang == 'zh' %}活动{% else %}Events{% endif %}
                    </a>
                    <a href="{% if meta.lang == 'ko' %}/ko/leaderboard/{% elif meta.lang == 'ja' %}/ja/leaderboard/{% elif meta.lang == 'zh' %}/zh/leaderboard/{% else %}/leaderboard/{% endif %}" style="font-weight:800;color:#d8ffe7">
                        {% if meta.lang == 'ko' %}리더보드{% elif meta.lang == 'ja' %}リーダーボード{% elif meta.lang == 'zh' %}排行榜{% else %}Leaderboard{% endif %}
                    </a>
                    <a class="btn-outline" href="{% if meta.lang == 'ko' %}/rewards/apply/ko/{% elif meta.lang == 'ja' %}/rewards/apply/ja/{% elif meta.lang == 'zh' %}/rewards/apply/zh/{% else %}/rewards/apply/{% endif %}">
                        {% if meta.lang == 'ko' %}캠페인 신청{% elif meta.lang == 'ja' %}キャンペーン申請{% elif meta.lang == 'zh' %}申请发起活动{% else %}Apply for campaign{% endif %}
                    </a>
                    {% if wallet_user %}
                    <span class="btn-outline">👛 {{ wallet_user.address }}</span>
                    <a class="btn" href="#" onclick="logoutWallet && logoutWallet();return false;">
                        {% if meta.lang == 'ko' %}로그아웃{% elif meta.lang == 'ja' %}ログアウト{% elif meta.lang == 'zh' %}退出{% else %}Logout{% endif %}
                    </a>
                    {% else %}
                    <a class="btn" href="#" onclick="connectWallet && connectWallet();return false;">
                        {% if meta.lang == 'ko' %}지갑 연결{% elif meta.lang == 'ja' %}ウォレット接続{% elif meta.lang == 'zh' %}连接钱包{% else %}Connect Wallet{% endif %}
                    </a>
                    {% endif %}
                    <!-- Language dropdown -->
                    <div class="lang" id="langSwitcher" data-current="{{ meta.lang|default:'en' }}">
                        <button
                            class="lang-btn"
                            type="button"
                            aria-haspopup="listbox"
                            aria-expanded="false"
                        >
                            <span class="flag-emoji" aria-hidden="true"></span>
                            <span class="label">
                                {% if meta.lang == 'ko' %}한국어{% elif meta.lang == 'ja' %}日本語{% elif meta.lang == 'zh' %}中文{% else %}English{% endif %}
                            </span>
                            <svg
                                class="chev"
                                viewBox="0 0 20 20"
                                width="16"
                                height="16"
                                aria-hidden="true"
                            >
                                <path
                                    d="M5 7l5 6 5-6"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="2"
                                    stroke-linecap="round"
                                />
                            </svg>
                        </button>
                        <ul
                            class="lang-menu"
                            role="listbox"
                            tabindex="-1"
                            aria-label="Select language"
                        >
                            <li
                                class="lang-item"
                                role="option"
                                data-lang="en"
                                data-flag="🇺🇸"
                            >🇺🇸 English</li>
                            <li
                                class="lang-item"
                                role="option"
                                data-lang="ko"
                                data-flag="🇰🇷"
                            >🇰🇷 한국어</li>
                            <li
                                class="lang-item"
                                role="option"
                                data-lang="ja"
                                data-flag="🇯🇵"
                            >🇯🇵 日本語</li>
                            <li
                                class="lang-item"
                                role="option"
                                data-lang="zh"
                                data-flag="🇨🇳"
                            >🇨🇳 中文</li>
                        </ul>
                    </div>
                </nav>
            </div>
        </header>
        <!-- HEADER -->
        <section class="page-head">
            <div class="container">
                <h1>
                    {% if meta.lang == 'ko' %}리더보드{% elif meta.lang == 'ja' %}リーダーボード{% elif meta.lang == 'zh' %}排行榜{% else %}Leaderboard{% endif %}
                </h1>
                <p class="sub">
                    {% if meta.lang == 'ko' %}
            캠페인 기여도 기반 순위 (링크·방문·점수).
          {% elif meta.lang == 'ja' %}
            キャンペーン貢献度に基づく順位（リンク・訪問・スコア）。
          {% elif meta.lang == 'zh' %}
            基于活动贡献的排名（外链、访问、积分）。
          {% else %}
            Ranked by campaign contributions (links, visits, score).
          {% endif %}
          {% if using_sample %}
                    <span class="muted"> · UI preview data</span>
                    {% endif %}
                </p>
                <div class="range">
                    <span class="muted">
                        {% if meta.lang == 'ko' %}기간{% elif meta.lang == 'ja' %}期間{% elif meta.lang == 'zh' %}时间范围{% else %}Range{% endif %}:
                    </span>
                    <a class="chip {% if range_code == '7d' %}active{% endif %}" href="?range=7d">7D</a>
                    <a class="chip {% if range_code == '30d' %}active{% endif %}" href="?range=30d">30D</a>
                    <a class="chip {% if range_code == '3m' %}active{% endif %}" href="?range=3m">3M</a>
                    <a class="chip {% if range_code == '6m' %}active{% endif %}" href="?range=6m">6M</a>
                    <a class="chip {% if range_code == '12m' %}active{% endif %}" href="?range=12m">12M</a>
                </div>
            </div>
        </section>
        <!-- TABLE -->
        <section class="container board">
            <div class="card">
                {% if rows %}
                <table aria-label="Leaderboard table">
                    <thead>
                        <tr>
                            <th style="width:70px;"></th>
                            <th>
                                {% if meta.lang == 'ko' %}지갑{% elif meta.lang == 'ja' %}ウォレット{% elif meta.lang == 'zh' %}钱包{% else %}Wallet{% endif %}
                            </th>
                            <th class="net-cell">
                                {% if meta.lang == 'ko' %}네트워크{% elif meta.lang == 'ja' %}ネットワーク{% elif meta.lang == 'zh' %}网络{% else %}Network{% endif %}
                            </th>
                            <th>
                                {% if meta.lang == 'ko' %}분할{% elif meta.lang == 'ja' %}内訳{% elif meta.lang == 'zh' %}占比{% else %}Split{% endif %}
                            </th>
                            <th class="stat">
                                {% if meta.lang == 'ko' %}링크{% elif meta.lang == 'ja' %}リンク{% elif meta.lang == 'zh' %}外链{% else %}Links{% endif %}
                            </th>
                            <th class="stat">
                                {% if meta.lang == 'ko' %}방문{% elif meta.lang == 'ja' %}訪問{% elif meta.lang == 'zh' %}访问{% else %}Visits{% endif %}
                            </th>
                            <th class="stat">
                                {% if meta.lang == 'ko' %}마인드셰어{% elif meta.lang == 'ja' %}マインドシェア{% elif meta.lang == 'zh' %}心智占有率{% else %}Mindshare{% endif %}
                            </th>
                            <th class="stat">
                                {% if meta.lang == 'ko' %}포인트{% elif meta.lang == 'ja' %}ポイント{% elif meta.lang == 'zh' %}积分{% else %}Points{% endif %}
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for r in rows %}
                        <tr>
                            <td class="rank">{{ r.rank }}</td>
                            <td>
                                <div class="user">
                                    <!-- inline SVG avatar -->
                                    <svg
                                        class="avatar"
                                        viewBox="0 0 40 40"
                                        aria-hidden="true"
                                        focusable="false"
                                    >
                                        <defs>
                                            <linearGradient
                                                id="g{{ forloop.counter }}"
                                                x1="0"
                                                y1="0"
                                                x2="1"
                                                y2="1"
                                            >
                                                <stop offset="0" stop-color="#19b357"/>
                                                <stop offset="1" stop-color="#23d16a"/>
                                            </linearGradient>
                                        </defs>
                                        <rect
                                            x="0.5"
                                            y="0.5"
                                            width="39"
                                            height="39"
                                            rx="19.5"
                                            fill="#0b1117"
                                            stroke="#1d2836"
                                        />
                                        <circle
                                            cx="20"
                                            cy="15"
                                            r="7"
                                            fill="url(#g{{ forloop.counter }})"
                                        />
                                        <rect
                                            x="10"
                                            y="25"
                                            width="20"
                                            height="8"
                                            rx="4"
                                            fill="#1d2836"
                                        />
                                    </svg>
                                    <div class="handle">
                                        {% if r.explorer_url %}
                                        <a
                                            class="addr"
                                            href="{{ r.explorer_url }}"
                                            target="_blank"
                                            rel="noopener"
                                            title="{{ r.address }}"
                                        >{{ r.address }}</a>
                                        {% else %}
                                        <span class="addr" title="{{ r.address }}">{{ r.address }}</span>
                                        {% endif %}
                                        <span class="muted">
                                            {% if meta.lang == 'ko' %}참여자{% elif meta.lang == 'ja' %}コントリビューター{% elif meta.lang == 'zh' %}贡献者{% else %}Contributor{% endif %}
                                        </span>
                                    </div>
                                </div>
                            </td>
                            <!-- Network cell with icon + localized name -->
                            <td class="net-cell">
                                <div class="net">
                                    {% if r.network == 'ETH' %}
                                    <img src="{% static 'img/networks/eth.svg' %}" alt="Ethereum">
                                    <span class="net-name">{% if meta.lang == 'ko' %}이더리움{% else %}Ethereum{% endif %}</span>
                                    {% elif r.network == 'POL' %}
                                    <img src="{% static 'img/networks/polygon.svg' %}" alt="Polygon">
                                    <span class="net-name">{% if meta.lang == 'ko' %}폴리곤{% else %}Polygon{% endif %}</span>
                                    {% elif r.network == 'BNB' %}
                                    <img src="{% static 'img/networks/bnb.svg' %}" alt="BNB Chain">
                                    <span class="net-name">{% if meta.lang == 'ko' %}BNB 체인{% else %}BNB Chain{% endif %}</span>
                                    {% elif r.network == 'SOL' %}
                                    <img src="{% static 'img/networks/solana.svg' %}" alt="Solana">
                                    <span class="net-name">{% if meta.lang == 'ko' %}솔라나{% else %}Solana{% endif %}</span>
                                    {% else %}
                                    <span class="net-name" style="opacity:.6">—</span>
                                    {% endif %}
                                </div>
                            </td>
                            <td style="min-width:260px;">
                                <div class="bar-split" style="--links: {{ r.ratio_links|floatformat:'2' }}%;" aria-label="Links {{ r.links }}, Visits {{ r.visits }}"></div>
                                <div class="split-meta">
                                    <span>
                                        {% if meta.lang == 'ko' %}링크{% elif meta.lang == 'ja' %}リンク{% elif meta.lang == 'zh' %}外链{% else %}Links{% endif %}
                    · {{ r.links }}
                                    </span>
                                    <span>
                                        {% if meta.lang == 'ko' %}방문{% elif meta.lang == 'ja' %}訪問{% elif meta.lang == 'zh' %}访问{% else %}Visits{% endif %}
                    · {{ r.visits }}
                                    </span>
                                </div>
                            </td>
                            <td class="stat">{{ r.links }}</td>
                            <td class="stat">{{ r.visits }}</td>
                            <td class="stat">{{ r.mindshare|floatformat:2 }}%</td>
                            <td class="stat">
                                <strong>{{ r.points }}</strong>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="empty">
                    {% if meta.lang == 'ko' %}
              아직 데이터가 없습니다. 과제에 참여하면 순위가 표시됩니다.
            {% elif meta.lang == 'ja' %}
              まだデータがありません。タスクに参加すると表示されます。
            {% elif meta.lang == 'zh' %}
              暂无数据。参与活动后将显示在此处。
            {% else %}
              No data yet. Participate in campaigns to appear here.
            {% endif %}
                </div>
                {% endif %}
            </div>
        </section>
        <!-- FOOTER -->
        <footer class="footer">
            <div class="container" style="display:flex; align-items:center; justify-content:space-between;">
                <div>
                    ©
                    <strong>LinkHash</strong>
                </div>
                <div style="opacity:.7">
                    {% if meta.lang == 'ko' %}화이트햇 백링크 · 투명한 리워드{% elif meta.lang == 'ja' %}ホワイトハット被リンク・透明な報酬{% elif meta.lang == 'zh' %}白帽外链 · 透明奖励{% else %}White-hat backlinks · Transparent rewards{% endif %}
                </div>
            </div>
        </footer>
        <!-- Language switcher -->
        <script>
      (function(){
        const $wrap = document.getElementById('langSwitcher');
        if(!$wrap) return;
        const $btn  = $wrap.querySelector('.lang-btn');
        const $menu = $wrap.querySelector('.lang-menu');
        const current = ($wrap.dataset.current || 'en').toLowerCase();

        const flagEl = $btn.querySelector('.flag-emoji');
        const flagMap = { en:'🇺🇸', ko:'🇰🇷', ja:'🇯🇵', zh:'🇨🇳' };
        flagEl.textContent = flagMap[current] || '🇺🇸';

        function close(){ $wrap.classList.remove('open'); $btn.setAttribute('aria-expanded','false'); }
        $btn.addEventListener('click', (e)=>{ e.stopPropagation(); $wrap.classList.toggle('open'); $btn.setAttribute('aria-expanded', $wrap.classList.contains('open')); });
        document.addEventListener('click', ()=> close());
        document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') close(); });

        function pathFor(lang){
          const loc = window.location;
          const path = loc.pathname;
          const clean = path.replace(/^\/(ko|ja|zh)(\/|$)/, '/'); // strip locale prefix if any
          const baseMap = { '/': true, '/rewards/': true, '/events/': true, '/leaderboard/': true };

          // /rewards/apply/ variants
          const isApply = /^\/rewards\/apply(\/(ko|ja|zh)\/)?$/.test(path);
          if(isApply){
            if(lang === 'en') return '/rewards/apply/?lang=en';
            return `/rewards/apply/${lang}/`;
          }

          if(baseMap[clean]){
            if(lang === 'en'){
              const q = new URLSearchParams(loc.search);
              q.set('lang','en');
              return clean + (q.toString() ? `?${q.toString()}` : '');
            }
            return clean === '/' ? `/${lang}/` : `/${lang}${clean}`;
          }

          // Unknown/other page (e.g., detail pages): keep path, toggle ?lang=xx
          const params = new URLSearchParams(loc.search);
          params.set('lang', lang);
          return path + (params.toString() ? `?${params.toString()}` : '');
        }

        $menu.querySelectorAll('.lang-item').forEach(li=>{
          li.addEventListener('click', ()=>{
            const lang = li.getAttribute('data-lang');
            const emoji = li.getAttribute('data-flag') || '';
            flagEl.textContent = emoji;
            $wrap.querySelector('.label').textContent =
              lang==='ko' ? '한국어' : lang==='ja' ? '日本語' : lang==='zh' ? '中文' : 'English';
            close();
            const target = pathFor(lang);
            if(target) window.location.href = target;
          });
        });
      })();
        </script>
        <!-- CSRF + Wallet helpers -->
        <script>
      function getCookie(name){
        const m = document.cookie.match(new RegExp('(^|; )' + encodeURIComponent(name) + '=([^;]*)'));
        return m ? decodeURIComponent(m[2]) : null;
      }
      async function apiGet(url){
        const r = await fetch(url, { credentials: 'same-origin' });
        if(!r.ok) throw new Error((await r.text()) || ('GET ' + url + ' failed'));
        return r.json();
      }
      async function apiPost(url, json){
        const r = await fetch(url, {
          method: 'POST',
          credentials: 'same-origin',
          headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') || '' },
          body: JSON.stringify(json || {})
        });
        if(!r.ok){
          let msg; try{ msg = (await r.json()).error }catch(e){ msg = await r.text(); }
          throw new Error(msg || ('POST ' + url + ' failed'));
        }
        return r.json();
      }

      async function connectWallet(){
        try{
          if(!window.ethereum){
            alert('MetaMask not detected. Please install MetaMask.');
            return;
          }
          const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
          const address = (accounts && accounts[0]) ? accounts[0] : null;
          if(!address){ alert('No account selected.'); return; }
          const nonceRes = await apiGet(`/api/auth/nonce?address=${encodeURIComponent(address)}`);
          if(!nonceRes.ok){ throw new Error(nonceRes.error || 'nonce error'); }
          const message = nonceRes.message || `LinkHash login\n\nNonce: ${nonceRes.nonce}\n\nThis signature proves you control this wallet.`;
          const signature = await window.ethereum.request({ method: 'personal_sign', params: [ message, address ] });
          const verifyRes = await apiPost('/api/auth/verify', { address, signature, message });
          if(verifyRes && verifyRes.ok) window.location.reload();
          else alert('Login failed.');
        }catch(err){
          console.error(err);
          alert('Wallet login failed: ' + (err && err.message ? err.message : err));
        }
      }

      async function logoutWallet(){
        try{ await apiPost('/api/auth/logout', {}); window.location.reload(); }
        catch(err){ console.error(err); alert('Logout failed: ' + (err && err.message ? err.message : err)); }
      }

      // Expose for inline handlers
      window.connectWallet = connectWallet;
      window.logoutWallet  = logoutWallet;
        </script>
    </body>
</html>
